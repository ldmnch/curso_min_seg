---
title: "Clase 5"
author: "Domenech Burin, Laia"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
date: "`r format(Sys.time(), '%d %B, %Y')`"
theme: Boadilla
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)
```

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE, collapse=TRUE, highlight=TRUE, paged.print=FALSE, prompt=TRUE, strip.white=FALSE)
```

## Introducción

Una de las grandes ventajas de `tidyverse` es el paquete para realizar gráficos, `ggplot`. Incluye funciones para realizar uan gran variedad de visualizaciones. Su concepto central es la asignación (*mapping* en inglés) de atributos estéticos a los valores que toma una variable. Dicho de otra forma, como mostrar de modo perceptible a la vista la diferencia entre valores: con distintos colores, distintos tamaños, distintas posiciones en un gráfico, etc.

```{r, echo=TRUE, warning=TRUE}
library(tidyverse)
```

Vamos a trabajar con la base de homicidios dolosos: 

```{r}
df <- readxl::read_xlsx("data/Integrado_HD_base_usuaria_2017-2020.xlsx")
```

## Uso de ggplot

Veamos qué sucede si llamamos solamente a la función:
```{r}
ggplot()
```

No se ve nada: nos aparece como un lienzo en blanco. Esto es porque necesitamos definir al menos una geometría (el recurso visual con el que vamos a mostrar la información, como líneas, puntos, barras, etc.) y al menos una asignación estética (especificar cuales variables queremos mostrar, y que atributo estético va a representar sus valores, como el color, el tamaño, la transparencia, etc.).

`ggplot()` implementa un marco teórico para la creación de visualizaciones, ["la gramática de los gráficos"](https://www.slideshare.net/0xdata/leland-wilkinson-h2oai-the-grammar-of-graphics-and-the-future-of-big-data-visualization-h2o-world-2019-nyc). Ésta permite expresar en forma concisa los componentes de un gráfico: 

![Diagrama de David Keyes](./img/ggplot_resumen.png)

Su funcionamiento básico consiste en:

- una llamada a la función `ggplot()`, pasándole un dataset y una "asignación de atributos estéticos" (_aesthetic mapping_ en inglés) usando `aes()` 
- al menos una capa "geom", que define el recurso gráfico que mostrará los datos; por ejemplo `geom_bar()` para dibujar barras.

Vamos a intentarlo. Asignémosle al atributo `x` la variable anio y usemos `geom_bar` para mostrar los datos.

```{r}
ggplot(df, aes(x=anio))+
        geom_bar()
```

`geom_bar` automáticamente hace el conteo de frecuencias para la variable deseada. `ggplot` [tiene un amplio repertorio de geometrías](https://www.maths.usyd.edu.au/u/UG/SM/STAT3022/r/current/Misc/data-visualization-2.1.pdf). Por ejemplo, también podemos usar `geom_line` para hacer gráficos de caja. Al hacer boxplots es común mostrar un gráfico separado para cada categoría presente en la data a mostrar, usando para eso el eje de las `x` o de las `y`. Pongamos `as.character(anio)` en el eje $x$ (como variable categórica), `cant_inc` en el eje de las $y$, y a dibujar cajas con `geom_boxplot()`.


```{r}
ggplot(df, aes(x=as.character(anio), y = cant_inc))+
        geom_boxplot()

```

## Combinación con gramática tidy

Al estar incluida en el mundo `tidyverse`, podemos combinar ggplot con otros objetos a través de `%>%`. Esto es útil sobre todo en combinación con la función `group_by()` para realizar conteos de frecuencias, sumas de columnas, y otras operaciones. Probemos agrupando la cantidad de víctimas por año y haciendo un gráfico que pone `anio` en el eje `x`, el `total` en el eje `y` y usa la geometría `geom_line()`.

```{r}
df %>% group_by(anio)%>%
        summarise(total=sum(cant_vic))%>%
        ggplot(aes(x=anio, y=total))+
        geom_line()
```
Combinando con tidyverse también podemos hacer un gráfico de frecuencias relativas de los casos registrados. Vamos a usar `group_by` para obtener los porcentajes y le vamos a pasar la variable `anio` al eje x, `perc` al eje y y la geometría `geom_col()`, que crea un gráfico de barras al cual se le puede pasar un valor al argumento y. 

```{r}
df %>% group_by(anio)%>%
        summarise(n=n())%>%
        ungroup()%>%
        mutate(total=sum(n),
               perc = (n/total)*100)%>%
        ggplot(aes(x=anio, y=perc))+
        geom_col()
```

## Agregándole color

Podemos mostrar más variables agregando colores a los gráficos. Vamos a hacer un conteo de las clases de arma según año, y graficarlo asignándole la variable `anio` al atributo `x`, `n` al atributo `y`, `clase_arma` al atributo `color` y le vamos a pasar la geometría `geom_line()`.

```{r}
df %>% group_by(anio, clase_arma)%>%
        summarise(n=n())%>%
        ggplot(aes(x=anio, y=n, color=clase_arma))+
        geom_line()

```
Vamos a hacer el gráfico de frecuencia de casos anuales pero introduciendo también la variable provincia. Repitamos el primer gráfico que hicimos pero asignándole al atributo `fill` la variable provincia, y el valor `fill` al atributo `position` dentro de la geometría. 

```{r}
ggplot(df, aes(x=anio, fill = provincia))+
        geom_bar(position = "fill")
```

`position = "fill"` indica que queremos que las categorías de la variable llenen la barra en una proporción de 0 a 1. Los otros dos valores que puede adoptar este argumento son `"stack"` o `"dodge"`. Prueben hacer el mismo gráfico cambiando esos valores a ver qué sucede:

```{r, eval = FALSE}
```

## Otros atributos estéticos

`coord_flip()` y `theme(axis.text.x = element_text(angle = 90))` son atributos útiles para utilizar cuando las categorías del eje x son muy largas y se superponen. Por ejemplo, hagamos un gráfico de barras de la cantidad de casos totales por provincia.  

```{r}
ggplot(df, aes(x=provincia))+
        geom_bar()
```

No se ve nada bien. Ahora, probemos el mismo gráfico con `coord_flip()`.

```{r}
ggplot(df, aes(x=provincia))+
        geom_bar()+
        coord_flip()
```

Y con la rotación de texto. 

```{r}
ggplot(df, aes(x=provincia))+
        geom_bar()+
        theme(axis.text.x = element_text(angle = 90))
```

Otros elementos que podemos modificar son los labels del gráfico. Con el atributo `labs` podemos modificar el título, subtítulo, epígrafe y ejes del gráfico. 

```{r}
ggplot(df, aes(x=provincia))+
        geom_bar()+
        coord_flip()+
        labs(
        title = "Homcidios dolosos registrados por provincia",
        subtitle = "2017-2020",
        caption = "Fuente: Ministerio de Seguridad de la Nación",
        x = "Provincia",
        y = "n"
        )
```

